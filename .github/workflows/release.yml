name: Release

on:
  release:
    types: [published]

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get release tag
        id: get_tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get manifest version
        id: get_version
        run: |
          version=$(jq -r '.version' custom_components/homeworks/manifest.json)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Validate version match
        run: |
          tag="${{ steps.get_tag.outputs.tag }}"
          version="${{ steps.get_version.outputs.version }}"

          # Remove 'v' prefix from tag if present
          tag_version="${tag#v}"

          if [ "$tag_version" != "$version" ]; then
            echo "::error::Version mismatch! Tag: $tag_version, Manifest: $version"
            exit 1
          fi

          echo "✅ Version match: $version"

  release-info:
    name: Release Info
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create release notes
        run: |
          echo "## Lutron Homeworks v${{ github.ref_name }}"
          echo ""
          echo "### Installation"
          echo "1. Add this repository to HACS as a custom repository"
          echo "2. Search for 'Lutron Homeworks' and install"
          echo "3. Restart Home Assistant"
          echo "4. Add the integration via Settings → Devices & Services"
